<div class="doc-container">
    <nav class="breadcrumb">
        <a routerLink="/home">üè† Accueil</a>
        <span class="separator">‚Ä∫</span>
        <a routerLink="/documentation">üìö Documentation</a>
        <span class="separator">‚Ä∫</span>
        <span class="current">HTTP Interceptors</span>
    </nav>

    <div class="doc-content">
        <header class="doc-header">
            <h1 class="display-4 mb-3">HTTP Interceptors</h1>
            <p class="lead text-muted">
                Les intercepteurs HTTP permettent d'inspecter et de transformer les requ√™tes et r√©ponses HTTP de mani√®re
                centralis√©e.
                Ils sont essentiels pour ajouter des tokens d'authentification, g√©rer les erreurs globalement, et logger
                les requ√™tes.
            </p>
        </header>

        <!-- Introduction -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Qu'est-ce qu'un Interceptor ?</h2>
            <div class="row">
                <div class="col-lg-8">
                    <p>
                        Un HTTP Interceptor est une fonction ou classe qui intercepte toutes les requ√™tes et r√©ponses
                        HTTP de votre application.
                        Il agit comme un middleware entre votre code et le serveur, permettant de modifier les requ√™tes
                        avant leur envoi
                        et les r√©ponses avant leur traitement.
                    </p>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Concept cl√© :</strong> Les intercepteurs forment une cha√Æne o√π chaque intercepteur peut
                        modifier la requ√™te/r√©ponse
                        avant de la passer au suivant.
                    </div>
                </div>
            </div>
        </section>

        <!-- Cas d'Usage -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Cas d'Usage des Interceptors</h2>

            <div class="row g-3 mb-4">
                @for (useCase of useCases; track useCase) {
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-body">
                            <i class="bi bi-check2-circle text-primary me-2"></i>
                            {{ useCase }}
                        </div>
                    </div>
                </div>
                }
            </div>
        </section>

        <!-- Flux d'Ex√©cution -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Flux d'Ex√©cution</h2>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        @for (step of interceptorFlow; track step.step) {
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <div class="badge bg-primary rounded-circle me-3"
                                    style="width: 40px; height: 40px; line-height: 28px; font-size: 1.1rem;">
                                    {{ step.step }}
                                </div>
                                <div>
                                    <strong>{{ step.description }}</strong>
                                </div>
                            </div>
                            @if (step.step !== '8') {
                            <div class="text-center my-2">
                                <i class="bi bi-arrow-down text-primary fs-4"></i>
                            </div>
                            }
                        </div>
                        }
                    </div>
                </div>
            </div>
        </section>

        <!-- Cr√©er un Interceptor (Functional) -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Cr√©er un Interceptor (Functional - Angular 15+)</h2>

            <div class="alert alert-success mb-4">
                <i class="bi bi-stars me-2"></i>
                <strong>Approche Moderne :</strong> Angular recommande les functional interceptors qui sont plus simples
                et performants.
            </div>

            <div class="code-example mb-4">
                <div class="code-header">
                    <span class="language-badge">TypeScript</span>
                    <span class="file-name">auth.interceptor.ts</span>
                </div>
                <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} inject {{ '}' }} from '&#64;angular/core';
import {{ '{' }} AuthService {{ '}' }} from './auth.service';

export const authInterceptor: HttpInterceptorFn = (req, next) => {{ '{' }}
  const authService = inject(AuthService);
  const token = authService.getToken();

  // Cloner la requ√™te et ajouter le header
  if (token) {{ '{' }}
    req = req.clone({{ '{' }}
      setHeaders: {{ '{' }}
        Authorization: `Bearer ${{ '{' }}token{{ '}' }}`
      {{ '}' }}
    {{ '}' }});
  {{ '}' }}

  // Passer au prochain intercepteur
  return next(req);
{{ '}' }};</code></pre>
            </div>

            <div class="code-example">
                <div class="code-header">
                    <span class="language-badge">TypeScript</span>
                    <span class="file-name">app.config.ts - Enregistrement</span>
                </div>
                <pre><code class="language-typescript">import {{ '{' }} ApplicationConfig {{ '}' }} from '&#64;angular/core';
import {{ '{' }} provideHttpClient, withInterceptors {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} authInterceptor {{ '}' }} from './interceptors/auth.interceptor';
import {{ '{' }} loggingInterceptor {{ '}' }} from './interceptors/logging.interceptor';
import {{ '{' }} errorInterceptor {{ '}' }} from './interceptors/error.interceptor';

export const appConfig: ApplicationConfig = {{ '{' }}
  providers: [
    provideHttpClient(
      withInterceptors([
        authInterceptor,      // Ordre d'ex√©cution
        loggingInterceptor,   // 1 -> 2 -> 3
        errorInterceptor
      ])
    )
  ]
{{ '}' }};</code></pre>
            </div>
        </section>

        <!-- Exemples Pratiques -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Exemples d'Interceptors</h2>

            <div class="row g-4">
                <div class="col-lg-6">
                    <h3 class="h5 mb-3">1. Logging Interceptor</h3>
                    <div class="code-example">
                        <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} tap {{ '}' }} from 'rxjs/operators';

export const loggingInterceptor: HttpInterceptorFn = 
  (req, next) => {{ '{' }}
  
  const started = Date.now();
  console.log(`‚Üí ${{ '{' }}req.method{{ '}' }} ${{ '{' }}req.url{{ '}' }}`);

  return next(req).pipe(
    tap({{ '{' }}
      next: (event) => {{ '{' }}
        if (event.type === HttpEventType.Response) {{ '{' }}
          const elapsed = Date.now() - started;
          console.log(
            `‚Üê ${{ '{' }}req.method{{ '}' }} ${{ '{' }}req.url{{ '}' }} ` +
            `(${{ '{' }}elapsed{{ '}' }}ms) Status: ${{ '{' }}event.status{{ '}' }}`
          );
        {{ '}' }}
      {{ '}' }},
      error: (err) => {{ '{' }}
        console.error(`‚úó ${{ '{' }}req.method{{ '}' }} ${{ '{' }}req.url{{ '}' }} Error:`, err);
      {{ '}' }}
    {{ '}' }})
  );
{{ '}' }};</code></pre>
                    </div>
                </div>

                <div class="col-lg-6">
                    <h3 class="h5 mb-3">2. Error Handler Interceptor</h3>
                    <div class="code-example">
                        <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} catchError {{ '}' }} from 'rxjs/operators';
import {{ '{' }} throwError {{ '}' }} from 'rxjs';
import {{ '{' }} inject {{ '}' }} from '&#64;angular/core';
import {{ '{' }} Router {{ '}' }} from '&#64;angular/router';

export const errorInterceptor: HttpInterceptorFn = 
  (req, next) => {{ '{' }}
  
  const router = inject(Router);

  return next(req).pipe(
    catchError((error) => {{ '{' }}
      let errorMessage = 'Une erreur est survenue';

      if (error.status === 401) {{ '{' }}
        errorMessage = 'Non autoris√©';
        router.navigate(['/login']);
      {{ '}' }} else if (error.status === 403) {{ '{' }}
        errorMessage = 'Acc√®s interdit';
      {{ '}' }} else if (error.status === 404) {{ '{' }}
        errorMessage = 'Ressource introuvable';
      {{ '}' }} else if (error.status >= 500) {{ '{' }}
        errorMessage = 'Erreur serveur';
      {{ '}' }}

      console.error('HTTP Error:', errorMessage, error);
      return throwError(() => new Error(errorMessage));
    {{ '}' }})
  );
{{ '}' }};</code></pre>
                    </div>
                </div>

                <div class="col-lg-6">
                    <h3 class="h5 mb-3">3. Loading Indicator Interceptor</h3>
                    <div class="code-example">
                        <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} inject {{ '}' }} from '&#64;angular/core';
import {{ '{' }} finalize {{ '}' }} from 'rxjs/operators';
import {{ '{' }} LoadingService {{ '}' }} from './loading.service';

export const loadingInterceptor: HttpInterceptorFn = 
  (req, next) => {{ '{' }}
  
  const loadingService = inject(LoadingService);
  loadingService.show();

  return next(req).pipe(
    finalize(() => loadingService.hide())
  );
{{ '}' }};

// Service
&#64;Injectable({{ '{' }} providedIn: 'root' {{ '}' }})
export class LoadingService {{ '{' }}
  private loading = new BehaviorSubject&lt;boolean&gt;(false);
  loading$ = this.loading.asObservable();

  show() {{ '{' }} this.loading.next(true); {{ '}' }}
  hide() {{ '{' }} this.loading.next(false); {{ '}' }}
{{ '}' }}</code></pre>
                    </div>
                </div>

                <div class="col-lg-6">
                    <h3 class="h5 mb-3">4. Cache Interceptor</h3>
                    <div class="code-example">
                        <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} of {{ '}' }} from 'rxjs';
import {{ '{' }} tap {{ '}' }} from 'rxjs/operators';

const cache = new Map&lt;string, any&gt;();

export const cacheInterceptor: HttpInterceptorFn = 
  (req, next) => {{ '{' }}
  
  // Cache uniquement les GET
  if (req.method !== 'GET') {{ '{' }}
    return next(req);
  {{ '}' }}

  const cachedResponse = cache.get(req.url);
  if (cachedResponse) {{ '{' }}
    console.log('Cache hit:', req.url);
    return of(cachedResponse.clone());
  {{ '}' }}

  return next(req).pipe(
    tap(response => {{ '{' }}
      cache.set(req.url, response.clone());
    {{ '}' }})
  );
{{ '}' }};</code></pre>
                    </div>
                </div>

                <div class="col-lg-6">
                    <h3 class="h5 mb-3">5. Retry Interceptor</h3>
                    <div class="code-example">
                        <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} retry, retryWhen, delay, take {{ '}' }} from 'rxjs/operators';

export const retryInterceptor: HttpInterceptorFn = 
  (req, next) => {{ '{' }}
  
  return next(req).pipe(
    retryWhen(errors => errors.pipe(
      delay(1000),   // Attendre 1s entre les tentatives
      take(3)        // Max 3 tentatives
    ))
  );
{{ '}' }};</code></pre>
                    </div>
                </div>

                <div class="col-lg-6">
                    <h3 class="h5 mb-3">6. Custom Headers Interceptor</h3>
                    <div class="code-example">
                        <pre><code class="language-typescript">import {{ '{' }} HttpInterceptorFn {{ '}' }} from '&#64;angular/common/http';

export const headersInterceptor: HttpInterceptorFn = 
  (req, next) => {{ '{' }}
  
  const modifiedReq = req.clone({{ '{' }}
    setHeaders: {{ '{' }}
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'X-App-Version': '1.0.0',
      'X-Request-ID': crypto.randomUUID()
    {{ '}' }}
  {{ '}' }});

  return next(modifiedReq);
{{ '}' }};</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- Class-based Interceptor (Legacy) -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Interceptor Bas√© sur Classe (Ancien Style)</h2>

            <div class="alert alert-warning mb-4">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Note :</strong> Cette approche est toujours support√©e mais les functional interceptors sont
                pr√©f√©r√©s.
            </div>

            <div class="code-example">
                <div class="code-header">
                    <span class="language-badge">TypeScript</span>
                    <span class="file-name">auth.interceptor.ts (class-based)</span>
                </div>
                <pre><code class="language-typescript">import {{ '{' }} Injectable {{ '}' }} from '&#64;angular/core';
import {{ '{' }} 
  HttpInterceptor, 
  HttpRequest, 
  HttpHandler, 
  HttpEvent 
{{ '}' }} from '&#64;angular/common/http';
import {{ '{' }} Observable {{ '}' }} from 'rxjs';

&#64;Injectable()
export class AuthInterceptor implements HttpInterceptor {{ '{' }}
  
  constructor(private authService: AuthService) {{ '{' }}{{ '}' }}

  intercept(
    req: HttpRequest&lt;any&gt;, 
    next: HttpHandler
  ): Observable&lt;HttpEvent&lt;any&gt;&gt; {{ '{' }}
    
    const token = this.authService.getToken();

    if (token) {{ '{' }}
      req = req.clone({{ '{' }}
        setHeaders: {{ '{' }}
          Authorization: `Bearer ${{ '{' }}token{{ '}' }}`
        {{ '}' }}
      {{ '}' }});
    {{ '}' }}

    return next.handle(req);
  {{ '}' }}
{{ '}' }}

// Enregistrement (ancien style)
providers: [
  {{ '{' }}
    provide: HTTP_INTERCEPTORS,
    useClass: AuthInterceptor,
    multi: true
  {{ '}' }}
]</code></pre>
            </div>
        </section>

        <!-- Best Practices -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Bonnes Pratiques</h2>

            <div class="row g-3 mb-4">
                @for (practice of bestPractices; track practice) {
                <div class="col-md-6">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-check-circle-fill text-success me-3 mt-1 fs-5"></i>
                        <div>{{ practice }}</div>
                    </div>
                </div>
                }
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-check-circle me-2"></i>√Ä Faire
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                <li>Utiliser functional interceptors (Angular moderne)</li>
                                <li>Toujours cloner la requ√™te avant modification</li>
                                <li>Garder les intercepteurs simples et focalis√©s</li>
                                <li>Retourner <code>next(req)</code> pour continuer la cha√Æne</li>
                                <li>Tester les intercepteurs isol√©ment</li>
                                <li>Documenter l'ordre des intercepteurs</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <i class="bi bi-x-circle me-2"></i>√Ä √âviter
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                <li>Ne pas modifier directement la requ√™te (immutable)</li>
                                <li>√âviter la logique m√©tier complexe dans les intercepteurs</li>
                                <li>Ne pas oublier de retourner <code>next(req)</code></li>
                                <li>√âviter trop d'intercepteurs (performance)</li>
                                <li>Ne pas bloquer le flux HTTP trop longtemps</li>
                                <li>√âviter les d√©pendances circulaires</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Exemple Complet -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Exemple Complet - Application R√©elle</h2>

            <div class="code-example">
                <div class="code-header">
                    <span class="language-badge">TypeScript</span>
                    <span class="file-name">app.config.ts - Configuration compl√®te</span>
                </div>
                <pre><code class="language-typescript">import {{ '{' }} ApplicationConfig {{ '}' }} from '&#64;angular/core';
import {{ '{' }} provideHttpClient, withInterceptors {{ '}' }} from '&#64;angular/common/http';

// Interceptors
import {{ '{' }} authInterceptor {{ '}' }} from './interceptors/auth.interceptor';
import {{ '{' }} loggingInterceptor {{ '}' }} from './interceptors/logging.interceptor';
import {{ '{' }} errorInterceptor {{ '}' }} from './interceptors/error.interceptor';
import {{ '{' }} loadingInterceptor {{ '}' }} from './interceptors/loading.interceptor';
import {{ '{' }} cacheInterceptor {{ '}' }} from './interceptors/cache.interceptor';

export const appConfig: ApplicationConfig = {{ '{' }}
  providers: [
    provideHttpClient(
      withInterceptors([
        loggingInterceptor,   // 1. Log toutes les requ√™tes
        authInterceptor,      // 2. Ajoute le token
        cacheInterceptor,     // 3. V√©rifie le cache
        loadingInterceptor,   // 4. Affiche le loading
        errorInterceptor      // 5. G√®re les erreurs
      ])
    )
  ]
{{ '}' }};

// L'ordre est important ! Chaque intercepteur s'ex√©cute dans l'ordre d√©fini.</code></pre>
            </div>
        </section>

        <!-- Resources -->
        <section class="doc-section mb-5">
            <h2 class="section-title">Ressources</h2>
            <div class="list-group">
                <a href="https://angular.dev/guide/http/interceptors" target="_blank"
                    class="list-group-item list-group-item-action">
                    <i class="bi bi-book me-2"></i>Documentation Angular - HTTP Interceptors
                </a>
                <a href="https://angular.dev/guide/http/setup" target="_blank"
                    class="list-group-item list-group-item-action">
                    <i class="bi bi-book me-2"></i>HTTP Setup Guide
                </a>
                <a href="https://blog.angular.io/angular-v15-is-now-available-df7be7f2f4c8" target="_blank"
                    class="list-group-item list-group-item-action">
                    <i class="bi bi-newspaper me-2"></i>Angular v15 - Functional Interceptors
                </a>
            </div>
        </section>

        <!-- Navigation -->
        <nav class="doc-navigation mt-5 pt-4 border-top">
            <div class="row">
                <div class="col-6">
                    <a routerLink="/documentation/http/http-client" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Pr√©c√©dent: HttpClient
                    </a>
                </div>
                <div class="col-6 text-end">
                    <a routerLink="/documentation/routing/router" class="btn btn-primary">
                        Suivant: Router<i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </nav>
    </div>
</div>