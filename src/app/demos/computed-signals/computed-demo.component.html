<div class="demo-container">
  <header class="demo-header">
    <h2>üßÆ Computed Signals - Calculs Automatiques</h2>
    <p class="subtitle">Comparez les calculs manuels vs automatiques avec computed signals</p>
    <div class="intro-box">
      <p><strong>üìö Ce que vous allez comprendre:</strong></p>
      <p>Les <strong>computed signals</strong> sont comme des formules Excel : quand vous changez une cellule, toutes les formules qui en d√©pendent se recalculent automatiquement! Aucun code manuel n√©cessaire.</p>
    </div>
  </header>

  <div class="comparison-grid">
    <!-- LEFT: Without Computed Signals -->
    <section class="demo-card manual">
      <div class="card-header">
        <h3>‚ùå Sans Computed Signals</h3>
        <span class="badge old">Calculs Manuels</span>
      </div>
      
      <div class="code-preview">
        <pre><code>// ‚ùå Approche Manuelle
subtotal = 0;
discount = 0;
tax = 0;
total = 0;

addItem() {{'{'}}>
  this.items.push(newItem);
  // ‚ö†Ô∏è VOUS DEVEZ recalculer TOUT
  this.recalculateAll();
{{'}'}}>

recalculateAll() {{'{'}}>
  // Ordre important! ‚ö†Ô∏è
  this.subtotal = this.calcSubtotal();
  this.discount = this.subtotal * 0.10;
  this.tax = (this.subtotal - this.discount) * 0.20;
  this.total = this.subtotal - this.discount + this.tax;
{{'}'}}

// Si vous oubliez recalculateAll()?
// ‚ùå Les valeurs restent anciennes!</code></pre>
      </div>
      
      <div class="cart-section">
        <div class="cart-header-row">
          <h4>Panier ({{ manualItems.length }} articles)</h4>
          <button (click)="addManualItem()" class="btn-add">‚ûï Ajouter</button>
        </div>
        
        <div class="items-list">
          @for (item of manualItems; track item.id) {
            <div class="item-row">
              <div class="item-info">
                <span class="item-name">{{ item.name }}</span>
                <span class="item-price">{{ item.price }}‚Ç¨</span>
              </div>
              <div class="item-controls">
                <button (click)="updateManualQuantity(item.id, -1)" class="btn-qty">-</button>
                <span class="qty">{{ item.quantity }}</span>
                <button (click)="updateManualQuantity(item.id, 1)" class="btn-qty">+</button>
                <button (click)="removeManualItem(item.id)" class="btn-remove">üóëÔ∏è</button>
              </div>
            </div>
          } @empty {
            <p class="empty">Panier vide</p>
          }
        </div>
        
        <div class="calculations">
          <div class="calc-flow">
            <div class="calc-step">
              <span class="step-label">Sous-total</span>
              <span class="step-value">{{ manualSubtotal.toFixed(2) }}‚Ç¨</span>
            </div>
            <div class="arrow">‚Üì</div>
            <div class="calc-step">
              <span class="step-label">Remise (-10%)</span>
              <span class="step-value discount">-{{ manualDiscount.toFixed(2) }}‚Ç¨</span>
            </div>
            <div class="arrow">‚Üì</div>
            <div class="calc-step">
              <span class="step-label">TVA (20%)</span>
              <span class="step-value tax">+{{ manualTax.toFixed(2) }}‚Ç¨</span>
            </div>
            <div class="arrow">‚Üì</div>
            <div class="calc-step total">
              <span class="step-label">TOTAL</span>
              <span class="step-value">{{ manualTotal.toFixed(2) }}‚Ç¨</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="issues">
        <h4>‚ö†Ô∏è Probl√®mes:</h4>
        <ul>
          <li>Doit appeler recalculateAll() √† chaque modification</li>
          <li>Facile d'oublier de recalculer</li>
          <li>Risque de donn√©es d√©synchronis√©es</li>
          <li>Code r√©p√©titif et difficile √† maintenir</li>
          <li>Ordre des calculs important (erreurs possibles)</li>
        </ul>
      </div>
    </section>

    <!-- RIGHT: With Computed Signals -->
    <section class="demo-card computed">
      <div class="card-header">
        <h3>‚úÖ Avec Computed Signals</h3>
        <span class="badge new">Automatique</span>
      </div>
      
      <div class="code-preview">
        <pre><code>// ‚úÖ Approche Computed Signals
items = signal&lt;Item[]&gt;([]);

// üéØ √âtape 1: D√©clarez les computed
subtotal = computed(() => {{'{'}}>
  return this.items().reduce((sum, item) => 
    sum + (item.price * item.quantity), 0);
{{'}'}});

// üéØ √âtape 2: Ils d√©pendent les uns des autres
discount = computed(() => this.subtotal() * 0.10);
tax = computed(() => 
  (this.subtotal() - this.discount()) * 0.20);
total = computed(() => 
  this.subtotal() - this.discount() + this.tax());

// üéØ √âtape 3: Modifiez juste le signal!
addItem() {{'{'}}>
  this.items.update(items => [...items, newItem]);
  // ‚úÖ MAGIE! Tous les computed se mettent
  // √† jour automatiquement dans le bon ordre!
{{'}'}}</code></pre>
      </div>
      
      <div class="cart-section highlight">
        <div class="cart-header-row">
          <h4>Panier ({{ items().length }} articles)</h4>
          <button (click)="addItem()" class="btn-add">‚ûï Ajouter</button>
        </div>
        
        <div class="items-list">
          @for (item of items(); track item.id) {
            <div class="item-row">
              <div class="item-info">
                <span class="item-name">{{ item.name }}</span>
                <span class="item-price">{{ item.price }}‚Ç¨</span>
              </div>
              <div class="item-controls">
                <button (click)="updateQuantity(item.id, -1)" class="btn-qty">-</button>
                <span class="qty">{{ item.quantity }}</span>
                <button (click)="updateQuantity(item.id, 1)" class="btn-qty">+</button>
                <button (click)="removeItem(item.id)" class="btn-remove">üóëÔ∏è</button>
              </div>
            </div>
          } @empty {
            <p class="empty">Panier vide</p>
          }
        </div>
        
        <div class="calculations">
          <div class="calc-flow auto">
            <div class="calc-step">
              <span class="step-label">Sous-total</span>
              <span class="step-value">{{ subtotal().toFixed(2) }}‚Ç¨</span>
              <span class="auto-badge">üîÑ Auto</span>
            </div>
            <div class="arrow">‚Üì</div>
            <div class="calc-step">
              <span class="step-label">Remise (-10%)</span>
              <span class="step-value discount">-{{ discount().toFixed(2) }}‚Ç¨</span>
              <span class="auto-badge">üîÑ Auto</span>
            </div>
            <div class="arrow">‚Üì</div>
            <div class="calc-step">
              <span class="step-label">TVA (20%)</span>
              <span class="step-value tax">+{{ tax().toFixed(2) }}‚Ç¨</span>
              <span class="auto-badge">üîÑ Auto</span>
            </div>
            <div class="arrow">‚Üì</div>
            <div class="calc-step total">
              <span class="step-label">TOTAL</span>
              <span class="step-value">{{ total().toFixed(2) }}‚Ç¨</span>
              <span class="auto-badge">üîÑ Auto</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="benefits">
        <h4>‚úÖ Avantages:</h4>
        <ul>
          <li>Recalcul automatique √† chaque changement</li>
          <li>Impossible d'oublier de recalculer</li>
          <li>Donn√©es toujours synchronis√©es</li>
          <li>Code plus simple et maintenable</li>
          <li>D√©pendances g√©r√©es automatiquement</li>
          <li>Optimisations de performance incluses</li>
        </ul>
      </div>
    </section>
  </div>

  <section class="explanation">
    <h3>üí° Comment fonctionnent les Computed Signals ?</h3>
    
    <div class="step-by-step">
      <div class="step-card">
        <div class="step-number">1Ô∏è‚É£</div>
        <h4>Cr√©ez un signal source</h4>
        <code>items = signal([]);</code>
        <p>C'est votre <strong>donn√©e de base</strong> que vous pouvez modifier.</p>
      </div>
      
      <div class="step-card">
        <div class="step-number">2Ô∏è‚É£</div>
        <h4>Cr√©ez des computed signals</h4>
        <code>subtotal = computed(() => this.items().reduce(...));</code>
        <p>Un computed <strong>√©coute automatiquement</strong> les signals qu'il utilise dans sa fonction.</p>
      </div>
      
      <div class="step-card">
        <div class="step-number">3Ô∏è‚É£</div>
        <h4>Cr√©ez des computed en cascade</h4>
        <code>discount = computed(() => this.subtotal() * 0.10);</code>
        <p>Un computed peut <strong>d√©pendre d'autres computed</strong>. Angular g√®re l'ordre automatiquement!</p>
      </div>
      
      <div class="step-card highlight">
        <div class="step-number">‚ú®</div>
        <h4>Modifiez le signal source</h4>
        <code>this.items.update(items => [...items, newItem]);</code>
        <p><strong>üéâ BOOM!</strong> Tous les computed se recalculent <strong>automatiquement</strong> dans le bon ordre!</p>
      </div>
    </div>
    
    <h3 style="margin-top: 3rem; text-align: center;">üìä Visualisation du Flux de D√©pendances</h3>
    <div class="flow-diagram">
      <div class="flow-step source">
        <div class="flow-icon">üì¶</div>
        <h4>Signal Source</h4>
        <code>items = signal([])</code>
        <p>Signal modifiable</p>
      </div>
      
      <div class="flow-arrow">‚Üí</div>
      
      <div class="flow-step">
        <div class="flow-icon">üßÆ</div>
        <h4>Computed 1</h4>
        <code>subtotal = computed(...)</code>
        <p>√âcoute items()</p>
      </div>
      
      <div class="flow-arrow">‚Üí</div>
      
      <div class="flow-step">
        <div class="flow-icon">üí∞</div>
        <h4>Computed 2</h4>
        <code>discount = computed(...)</code>
        <p>√âcoute subtotal()</p>
      </div>
      
      <div class="flow-arrow">‚Üí</div>
      
      <div class="flow-step">
        <div class="flow-icon"></div>
        <h4>Computed 3</h4>
        <code>tax = computed(...)</code>
        <p>√âcoute subtotal() et discount()</p>
      </div>
      
      <div class="flow-arrow">‚Üí</div>
      
      <div class="flow-step result">
        <div class="flow-icon">‚ú®</div>
        <h4>Computed 4</h4>
        <code>total = computed(...)</code>
        <p>√âcoute tout!</p>
      </div>
    </div>
    
    <div class="explanation-text">
      <p><strong>üéØ Principe (comme Excel):</strong></p>
      <p>Imaginez Excel : si la cellule A1 contient 10, et B1 contient <code>=A1*2</code>, alors B1 affiche 20. Si vous changez A1 √† 15, B1 devient automatiquement 30. <strong>C'est exactement ce que font les computed signals!</strong></p>
      
      <p><strong>‚ö° Performance (intelligent et efficace):</strong></p>
      <p>Les computed signals sont <strong>lazy</strong> : ils ne recalculent que quand quelqu'un lit leur valeur ET que leurs d√©pendances ont chang√©. Si rien ne change, ils retournent la valeur en cache. <strong>Z√©ro calcul inutile!</strong></p>
      
      <p><strong>‚úÖ Garantie (synchronisation parfaite):</strong></p>
      <p>Impossible d'avoir <code>total = 100‚Ç¨</code> alors que <code>subtotal = 50‚Ç¨</code>. Angular <strong>garantit math√©matiquement</strong> que toutes les valeurs sont coh√©rentes. Toujours!</p>
      
      <div class="analogy-box">
        <h4>üß† Analogie Simple:</h4>
        <p><strong>Sans computed:</strong> Vous √™tes un comptable avec une calculatrice. √Ä chaque modification, vous devez recalculer TOUTES les lignes √† la main. Si vous oubliez une ligne, vos totaux sont faux!</p>
        <p><strong>Avec computed:</strong> Vous avez un tableur Excel. Vous changez un chiffre, tout se recalcule instantan√©ment et automatiquement. Impossible de se tromper!</p>
      </div>
    </div>
  </section>

  <section class="use-cases">
    <h3> Cas d'Usage des Computed Signals</h3>
    <div class="use-cases-grid">
      <div class="use-case-card">
        <div class="use-case-icon">üõí</div>
        <h4>E-Commerce</h4>
        <p>Calculs de panier: sous-total, remises, taxes, total</p>
        <code>total = computed(() => subtotal() - discount() + tax())</code>
      </div>
      
      <div class="use-case-card">
        <div class="use-case-icon"></div>
        <h4>Tableaux de Bord</h4>
        <p>Statistiques d√©riv√©es: moyennes, pourcentages, agr√©gations</p>
        <code>average = computed(() => sum() / count())</code>
      </div>
      
      <div class="use-case-card">
        <div class="use-case-icon">üîç</div>
        <h4>Filtrage</h4>
        <p>Listes filtr√©es et tri√©es dynamiquement</p>
        <code>filtered = computed(() => items().filter(...))</code>
      </div>
      
      <div class="use-case-card">
        <div class="use-case-icon">‚úÖ</div>
        <h4>Validation</h4>
        <p>√âtat de validation de formulaires complexes</p>
        <code>isValid = computed(() => field1() && field2())</code>
      </div>
    </div>
  </section>
</div>
